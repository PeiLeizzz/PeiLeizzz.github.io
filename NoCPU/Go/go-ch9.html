<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《Go 语言圣经》基于共享变量的并发 | LazySwifts</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/sun.png">
    <script>var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?bfb42b068181dcaabb4335db407b2a6f";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();</script>
    <meta name="description" content="Take excellence as a habit">
    <link rel="preload" href="/assets/css/0.styles.a94fce00.css" as="style"><link rel="preload" href="/assets/js/app.80d57d75.js" as="script"><link rel="preload" href="/assets/js/3.187167f1.js" as="script"><link rel="preload" href="/assets/js/1.965fe851.js" as="script"><link rel="preload" href="/assets/js/95.cf7f5192.js" as="script"><link rel="prefetch" href="/assets/js/10.8d4c2312.js"><link rel="prefetch" href="/assets/js/100.0a18407d.js"><link rel="prefetch" href="/assets/js/101.19f6f4ae.js"><link rel="prefetch" href="/assets/js/102.c54cf054.js"><link rel="prefetch" href="/assets/js/103.69fb1121.js"><link rel="prefetch" href="/assets/js/104.611687e5.js"><link rel="prefetch" href="/assets/js/105.8c2687ef.js"><link rel="prefetch" href="/assets/js/106.80a01d9a.js"><link rel="prefetch" href="/assets/js/107.dd5a49ff.js"><link rel="prefetch" href="/assets/js/108.08705abd.js"><link rel="prefetch" href="/assets/js/11.e977e67e.js"><link rel="prefetch" href="/assets/js/12.768cb1dd.js"><link rel="prefetch" href="/assets/js/13.7d2faadb.js"><link rel="prefetch" href="/assets/js/14.ad6f91db.js"><link rel="prefetch" href="/assets/js/15.1d6e4aba.js"><link rel="prefetch" href="/assets/js/16.61e9d2b8.js"><link rel="prefetch" href="/assets/js/17.eff00b6e.js"><link rel="prefetch" href="/assets/js/18.1c434eee.js"><link rel="prefetch" href="/assets/js/19.9a42c247.js"><link rel="prefetch" href="/assets/js/20.608a8cef.js"><link rel="prefetch" href="/assets/js/21.73078f6d.js"><link rel="prefetch" href="/assets/js/22.3eb47e28.js"><link rel="prefetch" href="/assets/js/23.aa340a84.js"><link rel="prefetch" href="/assets/js/24.cc96dcab.js"><link rel="prefetch" href="/assets/js/25.ed9ccb6f.js"><link rel="prefetch" href="/assets/js/26.8f578880.js"><link rel="prefetch" href="/assets/js/27.a8973f37.js"><link rel="prefetch" href="/assets/js/28.4e94e363.js"><link rel="prefetch" href="/assets/js/29.38b7d140.js"><link rel="prefetch" href="/assets/js/30.d502c466.js"><link rel="prefetch" href="/assets/js/31.9ff5696c.js"><link rel="prefetch" href="/assets/js/32.dd094132.js"><link rel="prefetch" href="/assets/js/33.bb3526f0.js"><link rel="prefetch" href="/assets/js/34.0057fe6f.js"><link rel="prefetch" href="/assets/js/35.d20eed5b.js"><link rel="prefetch" href="/assets/js/36.dbf204b9.js"><link rel="prefetch" href="/assets/js/37.7c722428.js"><link rel="prefetch" href="/assets/js/38.e3cb4d47.js"><link rel="prefetch" href="/assets/js/39.9a9ca98e.js"><link rel="prefetch" href="/assets/js/4.12ddd8f1.js"><link rel="prefetch" href="/assets/js/40.af513c27.js"><link rel="prefetch" href="/assets/js/41.e27e05b9.js"><link rel="prefetch" href="/assets/js/42.db46fcd9.js"><link rel="prefetch" href="/assets/js/43.c52c461f.js"><link rel="prefetch" href="/assets/js/44.5172bb3f.js"><link rel="prefetch" href="/assets/js/45.51a56239.js"><link rel="prefetch" href="/assets/js/46.16b9c080.js"><link rel="prefetch" href="/assets/js/47.02ed6b2a.js"><link rel="prefetch" href="/assets/js/48.e963edec.js"><link rel="prefetch" href="/assets/js/49.418e2579.js"><link rel="prefetch" href="/assets/js/5.95952000.js"><link rel="prefetch" href="/assets/js/50.a21016c3.js"><link rel="prefetch" href="/assets/js/51.f9afb253.js"><link rel="prefetch" href="/assets/js/52.1b190232.js"><link rel="prefetch" href="/assets/js/53.df7d7fbe.js"><link rel="prefetch" href="/assets/js/54.4dbc9d3b.js"><link rel="prefetch" href="/assets/js/55.c52f1a6a.js"><link rel="prefetch" href="/assets/js/56.1ab37a88.js"><link rel="prefetch" href="/assets/js/57.e6ebb094.js"><link rel="prefetch" href="/assets/js/58.684481a7.js"><link rel="prefetch" href="/assets/js/59.d614f15a.js"><link rel="prefetch" href="/assets/js/6.d5aaee5e.js"><link rel="prefetch" href="/assets/js/60.34a45e4e.js"><link rel="prefetch" href="/assets/js/61.369433e8.js"><link rel="prefetch" href="/assets/js/62.b16c43d6.js"><link rel="prefetch" href="/assets/js/63.8e4ada6e.js"><link rel="prefetch" href="/assets/js/64.4caf02ad.js"><link rel="prefetch" href="/assets/js/65.0fe27510.js"><link rel="prefetch" href="/assets/js/66.03c91498.js"><link rel="prefetch" href="/assets/js/67.b0f1209b.js"><link rel="prefetch" href="/assets/js/68.bd58cd56.js"><link rel="prefetch" href="/assets/js/69.aa5cdeb9.js"><link rel="prefetch" href="/assets/js/7.28177048.js"><link rel="prefetch" href="/assets/js/70.f2942ca8.js"><link rel="prefetch" href="/assets/js/71.9c89b0d4.js"><link rel="prefetch" href="/assets/js/72.2ecdd4aa.js"><link rel="prefetch" href="/assets/js/73.cad7864b.js"><link rel="prefetch" href="/assets/js/74.8301c640.js"><link rel="prefetch" href="/assets/js/75.1617b729.js"><link rel="prefetch" href="/assets/js/76.5eb00565.js"><link rel="prefetch" href="/assets/js/77.3c32a3f6.js"><link rel="prefetch" href="/assets/js/78.1a7aadd7.js"><link rel="prefetch" href="/assets/js/79.b3895da2.js"><link rel="prefetch" href="/assets/js/8.f1421748.js"><link rel="prefetch" href="/assets/js/80.5286ee30.js"><link rel="prefetch" href="/assets/js/81.9a1e4dac.js"><link rel="prefetch" href="/assets/js/82.3e56e812.js"><link rel="prefetch" href="/assets/js/83.087a88de.js"><link rel="prefetch" href="/assets/js/84.8364b634.js"><link rel="prefetch" href="/assets/js/85.b19281d5.js"><link rel="prefetch" href="/assets/js/86.3889f38b.js"><link rel="prefetch" href="/assets/js/87.84348c9b.js"><link rel="prefetch" href="/assets/js/88.165a767d.js"><link rel="prefetch" href="/assets/js/89.016e9b11.js"><link rel="prefetch" href="/assets/js/9.c78676cf.js"><link rel="prefetch" href="/assets/js/90.93531463.js"><link rel="prefetch" href="/assets/js/91.8b3715fc.js"><link rel="prefetch" href="/assets/js/92.9251174a.js"><link rel="prefetch" href="/assets/js/93.f39d6513.js"><link rel="prefetch" href="/assets/js/94.32855f95.js"><link rel="prefetch" href="/assets/js/96.ceccefbf.js"><link rel="prefetch" href="/assets/js/97.f18f5c57.js"><link rel="prefetch" href="/assets/js/98.d6d13334.js"><link rel="prefetch" href="/assets/js/99.4bf4bf3c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a94fce00.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-19557b78><div data-v-19557b78><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-19557b78 data-v-19557b78><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-19557b78 data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>LazySwifts</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>LazySwifts</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-19557b78><header class="navbar" data-v-19557b78><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/headhead.png" alt="LazySwifts" class="logo"> <span class="site-name">LazySwifts</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont undefined"></i>
  Home
</a></div><div class="nav-item"><a href="/Guide/" class="nav-link"><i class="iconfont undefined"></i>
  Guide
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/NoCPU/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  NoCPU
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      CPU
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CPU/Database/" class="nav-link"><i class="iconfont undefined"></i>
  Database
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Management/" class="nav-link"><i class="iconfont undefined"></i>
  Management
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Java/" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Data Science/" class="nav-link"><i class="iconfont undefined"></i>
  Data Science
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Matlab/" class="nav-link"><i class="iconfont undefined"></i>
  Matlab
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Operating System/" class="nav-link"><i class="iconfont undefined"></i>
  Operating System
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Biochemistry and Microbiology/" class="nav-link"><i class="iconfont undefined"></i>
  Biochemistry and Microbiology
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Computer Network/" class="nav-link"><i class="iconfont undefined"></i>
  Computer Network
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Information Systems Analysis and Design/" class="nav-link"><i class="iconfont undefined"></i>
  Information Systems Analysis and Design
</a></li></ul></div></div><div class="nav-item"><a href="mailto:714838284@qq.com" class="nav-link external"><i class="iconfont undefined"></i>
  Contact Me
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-19557b78></div> <aside class="sidebar" data-v-19557b78><div class="personal-info-wrapper" data-v-042e23d4><img src="/headhead.png" alt="author-avatar" class="personal-img" data-v-042e23d4> <h3 class="name" data-v-042e23d4>
    LazySwifts
  </h3> <div class="num" data-v-042e23d4><div data-v-042e23d4><h3 data-v-042e23d4>80</h3> <h6 data-v-042e23d4>Article</h6></div> <div data-v-042e23d4><h3 data-v-042e23d4>26</h3> <h6 data-v-042e23d4>Tag</h6></div></div> <hr data-v-042e23d4></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont undefined"></i>
  Home
</a></div><div class="nav-item"><a href="/Guide/" class="nav-link"><i class="iconfont undefined"></i>
  Guide
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/NoCPU/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  NoCPU
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      CPU
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CPU/Database/" class="nav-link"><i class="iconfont undefined"></i>
  Database
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Management/" class="nav-link"><i class="iconfont undefined"></i>
  Management
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Java/" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Data Science/" class="nav-link"><i class="iconfont undefined"></i>
  Data Science
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Matlab/" class="nav-link"><i class="iconfont undefined"></i>
  Matlab
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Operating System/" class="nav-link"><i class="iconfont undefined"></i>
  Operating System
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Biochemistry and Microbiology/" class="nav-link"><i class="iconfont undefined"></i>
  Biochemistry and Microbiology
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Computer Network/" class="nav-link"><i class="iconfont undefined"></i>
  Computer Network
</a></li><li class="dropdown-item"><!----> <a href="/CPU/Information Systems Analysis and Design/" class="nav-link"><i class="iconfont undefined"></i>
  Information Systems Analysis and Design
</a></li></ul></div></div><div class="nav-item"><a href="mailto:714838284@qq.com" class="nav-link external"><i class="iconfont undefined"></i>
  Contact Me
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/NoCPU/" aria-current="page" class="sidebar-link">Tell You</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deep Learning</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NLP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>C++</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Go</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/NoCPU/Go/" aria-current="page" class="sidebar-link">Tell You</a></li><li><a href="/NoCPU/Go/go-ch1.html" class="sidebar-link">《Go 语言圣经》前言、入门</a></li><li><a href="/NoCPU/Go/go-ch2.html" class="sidebar-link">《Go 语言圣经》程序结构</a></li><li><a href="/NoCPU/Go/go-ch3.html" class="sidebar-link">《Go 语言圣经》基础数据类型</a></li><li><a href="/NoCPU/Go/go-ch4.html" class="sidebar-link">《Go 语言圣经》复合数据类型</a></li><li><a href="/NoCPU/Go/go-ch5.html" class="sidebar-link">《Go 语言圣经》函数</a></li><li><a href="/NoCPU/Go/go-ch6.html" class="sidebar-link">《Go 语言圣经》方法</a></li><li><a href="/NoCPU/Go/go-ch7.html" class="sidebar-link">🔺《Go 语言圣经》接口</a></li><li><a href="/NoCPU/Go/go-ch8.html" class="sidebar-link">🔺《Go 语言圣经》Goroutines 和 Channels</a></li><li><a href="/NoCPU/Go/go-ch9.html" aria-current="page" class="active sidebar-link">🔺《Go 语言圣经》基于共享变量的并发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NoCPU/Go/go-ch9.html#基于共享变量的并发" class="sidebar-link">基于共享变量的并发</a></li></ul></li><li><a href="/NoCPU/Go/go-ch10.html" class="sidebar-link">《Go 语言圣经》包和工具</a></li><li><a href="/NoCPU/Go/go-ch11.html" class="sidebar-link">《Go 语言圣经》测试</a></li><li><a href="/NoCPU/Go/go-ch12.html" class="sidebar-link">《Go 语言圣经》反射</a></li><li><a href="/NoCPU/Go/go-ch12.html" class="sidebar-link">《Go 语言圣经》unsafe 包底层编程</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>LeetCode</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Software Engineering</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>保研</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>《Go 语言圣经》基于共享变量的并发</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>LazySwifts</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-19557b78><main class="page"><div class="page-title" style="display:none;"><h1>《Go 语言圣经》基于共享变量的并发</h1> <hr> <div data-v-34ea29db><i class="iconfont reco-account" data-v-34ea29db><span data-v-34ea29db>LazySwifts</span></i> <i class="iconfont reco-date" data-v-34ea29db><span data-v-34ea29db>2022-04-06 19:15:47</span></i> <i class="iconfont reco-eye" data-v-34ea29db><span id="/NoCPU/Go/go-ch9.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-34ea29db><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="iconfont reco-tag tags" data-v-34ea29db><span class="tag-item" data-v-34ea29db>Go</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h2 id="基于共享变量的并发"><a href="#基于共享变量的并发" class="header-anchor">#</a> 基于共享变量的并发</h2> <ul><li><p>什么是并发？没有自信去确认一个事件是在另一个事件之前或之后，则这两个事件是并发的。</p> <p>如果一个函数在线性程序中可以正确地工作，在并发的情况下依然能正确地工作，则这个函数是并发安全的，并发安全的函数不需要额外的同步工作；对于某个类型来说，如果其所有可访问的方法和操作都是并发安全的，则该类型就是并发安全的。</p> <p>并发安全的类型是少数，我们应该避免并发访问大多数的类型，无论是将变量局限在单一的一个 goroutine 内，还是用互斥条件维持更高级别的不变性，都是为了这个目的。</p> <p>包级别导出的函数一般情况下都是并发安全的，但是包级别的变量没法被限制在单一的 goroutine，修改这些变量必须使用互斥条件。</p> <blockquote><p>函数在并发调用时产生的问题：竞争、死锁、活锁、饿死</p></blockquote> <p>竞争：</p> <ul><li><p>数据竞争：<strong>无论任何时候，只要有两个 goroutine 并发访问同一变量，且至少其中的一个是写操作的时候就会发生数据竞争</strong></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> bank
<span class="token keyword">var</span> balance <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token function">Deposit</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> amount <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> balance <span class="token punctuation">}</span>

<span class="token comment">// Alice:</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bank<span class="token punctuation">.</span><span class="token function">Deposit</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>                <span class="token comment">// A1</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> bank<span class="token punctuation">.</span><span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// A2</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Bob:</span>
<span class="token keyword">go</span> bank<span class="token punctuation">.</span><span class="token function">Deposit</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>                 <span class="token comment">// B</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>上面的代码在并发的情况下会有多种顺序：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>Alice first        Bob first        Alice<span class="token operator">/</span>Bob<span class="token operator">/</span>Alice
          <span class="token number">0</span>                <span class="token number">0</span>                      <span class="token number">0</span>
  A1    <span class="token number">200</span>        B     <span class="token number">100</span>             A1     <span class="token number">200</span>
  A2 <span class="token string">&quot;= 200&quot;</span>       A1    <span class="token number">300</span>             B      <span class="token number">300</span>
  B     <span class="token number">300</span>        A2 <span class="token string">&quot;= 300&quot;</span>            A2  <span class="token string">&quot;= 300&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>但实际上 Deposit 中的操作并不是一个原子操作，<code>balance = balance + amount</code> 应该分为两步：</p> <ol><li>读取旧 balance</li> <li>更新 balance（写）</li></ol> <p>所以还会有如下的情况：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>Data race
<span class="token number">0</span>
A1r      <span class="token number">0</span>     <span class="token operator">...</span> <span class="token operator">=</span> balance <span class="token operator">+</span> amount 读取旧 balance
B      <span class="token number">100</span>     此时 B 更新了 balance
A1w    <span class="token number">200</span>     balance <span class="token operator">=</span> <span class="token operator">...</span> 更新 balance（导致 B 的更新丢失）
A2  <span class="token string">&quot;= 200&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>解决方式：</p> <ol><li><p>不要写变量</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> icons <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>image<span class="token punctuation">.</span>Image<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">loadIcon</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> image<span class="token punctuation">.</span>Image

<span class="token keyword">func</span> <span class="token function">Icon</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> image<span class="token punctuation">.</span>Image <span class="token punctuation">{</span>
  icon<span class="token punctuation">,</span> ok <span class="token operator">:=</span> icons<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
    icon <span class="token operator">=</span> <span class="token function">loadIcon</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    icons<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> icon
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> icon
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>上述例子在 Icon 被顺序调用时正常，但如果 Icon 被并发调用，则会存在数据竞争。</p> <p>一个解决办法是直接在 map 中初始化所有条目，之后不再修改，那么并发访问都是安全的。（但很多时候必须要更新信息）</p></li> <li><p><strong>避免从多个 goroutine 访问变量</strong>。比如只使用一个 goroutine 来访问变量，其他 goroutine 只能使用 channel 来发送请求给指定的 goroutine 来查询更新变量。</p> <blockquote><p>不要使用共享数据来通信，而是使用通信来共享数据</p></blockquote> <p>一个使用 channel 来限制对指定变量的访问的 goroutine 叫做这个变量的 monitor goroutine。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> deposits <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> balances <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Deposit</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	deposits <span class="token operator">&lt;-</span> amount
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&lt;-</span>balances
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">teller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> balance <span class="token builtin">int</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> amount <span class="token operator">:=</span> <span class="token operator">&lt;-</span>deposits<span class="token punctuation">:</span>
			balance <span class="token operator">+=</span> amount
		<span class="token keyword">case</span> balances <span class="token operator">&lt;-</span> balance<span class="token punctuation">:</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">go</span> <span class="token function">teller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// monitor goroutine</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></li> <li><p>串行绑定：即使不能限制一个变量在其生命周期内被绑定到一个 goroutine 上，也可以限制其在某一阶段只能被一个 goroutine 绑定。例如在一条流水线上的 goroutine 之间共享变量是很普遍的行为，在这两者间会通过 channel 来传输地址信息。如果流水线的<strong>每一个阶段都能够避免在将变量传送到下一阶段后再去访问它</strong>，那么对这个变量的所有访问就是线性的。其效果是变量会被绑定到流水线的一个阶段，传送完之后被绑定到下一个，以此类推。这种规则有时被称为串行绑定。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Cake <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  state <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">baker</span><span class="token punctuation">(</span>cooked <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token operator">*</span>Cake<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">{</span>
    cake <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Cake<span class="token punctuation">)</span>
    cake<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">&quot;cooked&quot;</span>
    cooked <span class="token operator">&lt;-</span> cake
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">icer</span><span class="token punctuation">(</span>iced <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token operator">*</span>Cake<span class="token punctuation">,</span> cooked <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token operator">*</span>Cake<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> cake <span class="token operator">:=</span> <span class="token keyword">range</span> cooked <span class="token punctuation">{</span>
    cake<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">&quot;iced&quot;</span>
    iced <span class="token operator">&lt;-</span> cake
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li> <li><p>允许很多 goroutine 访问变量，但同一个时刻最多只有一个 goroutine 在访问（互斥）</p></li></ol></li></ul></li> <li><p>sync.Mutex 互斥锁</p> <ol><li><p>用容量为 1 的 channel 来保证最多只有一个 goroutine 在同一时刻访问一个共享变量</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	sema    <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	balance <span class="token builtin">int</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Deposit</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	sema <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	balance <span class="token operator">=</span> balance <span class="token operator">+</span> amount
	<span class="token operator">&lt;-</span>sema
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	sema <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	b <span class="token operator">:=</span> balance
	<span class="token operator">&lt;-</span>sema
	<span class="token keyword">return</span> b
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li> <li><p>使用 <code>sync.Mutex</code>，它的 <code>Lock</code> 方法能够获取到<strong>互斥锁</strong>，<code>Unlock</code> 方法会释放锁</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	mu      sync<span class="token punctuation">.</span>Mutex
	balance <span class="token builtin">int</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Deposit</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	balance <span class="token operator">=</span> balance <span class="token operator">+</span> amount
	mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	b <span class="token operator">:=</span> balance
	mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> b
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><blockquote><p>按照惯例，mutex 所保护的变量是在 mutex 变量声明之后立刻声明的</p></blockquote> <p>上面的程序例证了一种通用的并发模式。一系列的导出函数封装了一个或多个变量，那么访问这些变量唯一的方式就是通过这些函数来做（或者方法，对于一个对象的变量来说）。每一个函数在一开始就获取互斥锁并在最后释放锁，从而保证共享变量不会被同时访问。这种函数、互斥锁和变量的编排叫作监控 monitor。</p> <p>上面程序的临界区很短（就一行代码），所以在最后进行 <code>mu.Unlock()</code> 很直接，但是在更复杂的临界区中（尤其是要处理错误并返回的情况下），难以判断对 <code>Lock</code> 和 <code>Unlock</code> 的调用在所有路径中严格匹配，所以需要 <code>defer</code>，让临界区隐式地延伸到函数作用域的最后。这样就不用在每次遇到错误返回之前先 <code>Unlock</code>。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
  mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> balance
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>defer 调用只会比显式调用成本高一点点，但是能提高代码的整洁性，所以应该尽量使用 defer 将临界区扩展到函数的结束。同时，deferred Unlock 即使在临界区出现 panic 时依然会运行，这对于用 recover 来恢复的程序来说很重要。</p></li></ol> <ul><li><ul><li>下面这个取款函数虽然可以给出正确的结果，但是存在副作用：当过多的取款操作同时执行时，balance 可能会瞬时被减到 0 以下。A 要取 10 元，B 要取 10 万元，并发的取款会导致 A 取不到 10 元。这里的问题在于，取款不是一个原子操作，包含了三步，且每一次上锁都不会包括整个流程。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Withdraw</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
  <span class="token function">Deposit</span><span class="token punctuation">(</span><span class="token operator">-</span>amount<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token function">Deposit</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>一个错误的解决方式：第一个 Deposit 会被永远阻塞</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Withdraw</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
  mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">Deposit</span><span class="token punctuation">(</span><span class="token operator">-</span>amount<span class="token punctuation">)</span> <span class="token comment">// 在 Deposit 中调用 mu.Lock() 没用，因为 mutex 已经被锁上了，此时程序会死锁</span>
  <span class="token keyword">if</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token function">Deposit</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>Go 中的 Mutex 无法被重入</p> <p>mutex的目的是确保共享变量在程序执行时的关键点上能够保证不变性。不变性的一层含义是“没有goroutine访问共享变量”，但实际上这里对于mutex保护的变量来说，不变性还包含更深层含义：当一个goroutine获得了一个互斥锁时，它能断定被互斥锁保护的变量正处于不变状态（译注：即没有其他代码块正在读写共享变量），在其获取并保持锁期间，可能会去更新共享变量，这样不变性只是短暂地被破坏，然而当其释放锁之后，锁必须保证共享变量重获不变性并且多个goroutine按顺序访问共享变量。尽管一个可以重入的mutex也可以保证没有其它的goroutine在访问共享变量，但它不具备不变性更深层含义（没有其他代码块正在读写共享变量）。</p></blockquote> <p>一个通用的解决方案是<strong>将一个函数分离为多个函数</strong>，导出与不导出两个函数，导出函数保证互斥访问，不导出函数默认锁总是会被保持并去做实际的操作：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">deposit</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  balance <span class="token operator">+=</span> amount
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">Deposit</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">deposit</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> balance
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Withdraw</span><span class="token punctuation">(</span>amount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">deposit</span><span class="token punctuation">(</span><span class="token operator">-</span>amount<span class="token punctuation">)</span>
	<span class="token keyword">if</span> balance <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">deposit</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>当使用 mutex 时，确保 mutex 和其保护的变量没有被导出（通过封装获得并发的不变性）</p></li></ul></li> <li><p>sync.RWMutex 读写锁</p> <p>由于 Balanc e函数只需要读取变量的状态，所以我们同时让多个 Balance 调用并发运行事实上是安全的，<strong>只要在运行的时候没有存款或者取款操作就行</strong>。在这种场景下我们需要一种特殊类型的锁，其<strong>允许多个只读操作并行执行，但写操作会完全互斥</strong>。这种锁叫作“多读单写”锁（multiple readers, single writer lock）</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>RWMutex
<span class="token keyword">var</span> balance <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token function">Balance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
  mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> balance
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>RLock 只能在临界区共享变量没有任何写入操作时可用。</p> <blockquote><p>一般来说，我们不应该假设逻辑上的只读函数/方法也不会去更新某一些变量。比如一个方法功能是访问一个变量，但它也有可能会同时去给一个内部的计数器+1（译注：可能是记录这个方法的访问次数啥的），或者去更新缓存——使即时的调用能够更快。如果有疑惑的话，请使用互斥锁。</p> <p>RWMutex只有当获得锁的大部分goroutine都是读操作，而锁在竞争条件下，也就是说，goroutine们必须等待才能获取到锁的时候，RWMutex才是最能带来好处的。RWMutex需要更复杂的内部记录，所以会让它比一般的无竞争锁的mutex慢一些。</p></blockquote></li> <li><p>内存同步</p> <p>Balance 函数只是读 balance 变量，为什么需要互斥条件？这可能涉及到内存的问题。</p> <p>在现代计算机中可能会有一堆处理器，每一个都会有其本地缓存（local cache）。为了效率，对内存的写入一般会在每一个处理器中缓冲，并在必要时<strong>一起</strong>flush到主存。<strong>这种情况下这些数据可能会以与当初goroutine写入顺序不同的顺序被提交到主存</strong>。像channel通信或者互斥量操作这样的原语会使处理器将其聚集的写入flush并commit（显式同步），这样goroutine在某个时间点上的执行结果才能被其它处理器上运行的goroutine得到。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> x<span class="token punctuation">,</span> y <span class="token builtin">int</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    x <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// A1</span>
    fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;y:&quot;</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span> <span class="token comment">// A2</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    y <span class="token operator">=</span> <span class="token number">1</span>                   <span class="token comment">// B1</span>
    fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;x:&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span> <span class="token comment">// B2</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可能会得到这样的输出：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>x<span class="token punctuation">:</span><span class="token number">0</span> y<span class="token punctuation">:</span><span class="token number">0</span>
y<span class="token punctuation">:</span><span class="token number">0</span> x<span class="token punctuation">:</span><span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>在一个独立的goroutine中，每一个语句的执行顺序是可以被保证的，也就是说goroutine内顺序是连贯的。但是在不使用channel且不使用mutex这样的<strong>显式同步</strong>操作时，我们就<strong>没法保证事件在不同的goroutine中看到的执行顺序是一致的</strong>了。尽管goroutine A中一定需要观察到x=1执行成功之后才会去读取y，但<strong>它没法确保自己观察得到goroutine B中对y的写入</strong>，所以A还可能会打印出y的一个旧版的值。</p> <p>尽管去理解并发的一种尝试是去将其运行理解为不同goroutine语句的交错执行，但看看上面的例子，这已经不是现代的编译器和cpu的工作方式了。<strong>因为赋值和打印指向不同的变量，编译器可能会断定两条语句的顺序不会影响执行结果，并且会交换两个语句的执行顺序</strong>（指令重排）。如果两个goroutine在不同的CPU上执行，每一个核心有自己的缓存，这样<strong>一个goroutine的写入对于其它goroutine的Print，在主存同步之前就是不可见的了</strong>。所以可能的话，将变量限定在goroutine内部；如果是多个goroutine都需要访问的变量，使用互斥条件来访问。</p> <p>《深入理解 Java 虚拟机》- P374：如果在一个线程观察另一个线程，所有操作都是无序的指的是 “指令重排序” 和 “工作内存与主内存同步延迟” 现象</p> <p><strong>缺少显式的同步，编译器和CPU是可以随意地去更改访问内存的指令顺序，以任意方式，只要保证每一个goroutine自己的执行顺序一致。</strong></p></blockquote> <p>==所以可能的话，将变量限定在goroutine内部；如果是多个goroutine都需要访问的变量，使用互斥条件来访问。==</p></li> <li><p>sync.Once 惰性初始化：在程序用到的时候再去初始化这些变量</p> <p>一个简单的惰性初始化：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> icons <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>image<span class="token punctuation">.</span>Image

<span class="token keyword">func</span> <span class="token function">loadIcons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    icons <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>image<span class="token punctuation">.</span>Image<span class="token punctuation">{</span>
        <span class="token string">&quot;spades.png&quot;</span><span class="token punctuation">:</span>   <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;spades.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;hearts.png&quot;</span><span class="token punctuation">:</span>   <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;hearts.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;diamonds.png&quot;</span><span class="token punctuation">:</span> <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;diamonds.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;clubs.png&quot;</span><span class="token punctuation">:</span>    <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;clubs.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// NOTE: not concurrency-safe!</span>
<span class="token keyword">func</span> <span class="token function">Icon</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> image<span class="token punctuation">.</span>Image <span class="token punctuation">{</span>
    <span class="token keyword">if</span> icons <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">loadIcons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// one-time initialization</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> icons<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>如果 Icon 只被单独的 goroutine 访问时，是安全的。但并发调用时并不安全，直觉会告诉我们最差的情况是 loadIcons 函数被多次访问会带来数据竞争。当第一个 goroutine 在忙着 loading 这些 icons 的时候，另一个 goroutine 进入了 Icon 函数，发现变量是 nil，然后也会调用 loadIcons 函数。</p> <p>但这个直觉是错误的，因为缺少显式的同步，CPU和编译器可能会让指令重排：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">loadIcons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    icons <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>image<span class="token punctuation">.</span>Image<span class="token punctuation">)</span>
    icons<span class="token punctuation">[</span><span class="token string">&quot;spades.png&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;spades.png&quot;</span><span class="token punctuation">)</span>
    icons<span class="token punctuation">[</span><span class="token string">&quot;hearts.png&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;hearts.png&quot;</span><span class="token punctuation">)</span>
    icons<span class="token punctuation">[</span><span class="token string">&quot;diamonds.png&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;diamonds.png&quot;</span><span class="token punctuation">)</span>
    icons<span class="token punctuation">[</span><span class="token string">&quot;clubs.png&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">loadIcon</span><span class="token punctuation">(</span><span class="token string">&quot;clubs.png&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>因此，一个 goroutine（A） 在检查 icons 是非空时，也并不能就假设这个变量的初始化流程已经走完了。可能在另一个 goroutine（B） 中，icons 仅仅还只是被成为一个 empty map（或者还没有填完所有值），然后 goroutine（A）直接返回了 <code>icons[name]</code> 造成与预期不符的情况。</p> <ul><li><p>可以通过一个 mutex 来同步检查：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>Mutex
<span class="token keyword">var</span> icons <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>image<span class="token punctuation">.</span>Image

<span class="token keyword">func</span> <span class="token function">Icon</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> image<span class="token punctuation">.</span>Image <span class="token punctuation">{</span>
  mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> icons <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token function">loadIcons</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> icons<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>但 <code>sync.Mutex</code> 的引入会导致变量已经初始化完毕之后，也不能被并发访问，可以改用 <code>sync.RWMutex</code>:</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>RWMutex
<span class="token keyword">var</span> icons <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>image<span class="token punctuation">.</span>Image

<span class="token keyword">func</span> <span class="token function">Icon</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> image<span class="token punctuation">.</span>Image <span class="token punctuation">{</span>
  mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> icons <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    icon <span class="token operator">:=</span> icon<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> icon
  <span class="token punctuation">}</span>
  mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 不释放共享锁的话，没有办法将共享锁升级为一个互斥锁</span>
  
  <span class="token comment">// 这里必须重新检查 icons == nil（原因是中间释放了共享锁）</span>
  <span class="token comment">// 防止 mu.RUnlock() 执行完、mu.Lock() 还没执行的间隙，另一个 goroutine 已经完成了初始化。</span>
  mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 互斥锁</span>
  <span class="token keyword">if</span> icons <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token function">loadIcons</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  icon <span class="token operator">:=</span> icons<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> icon
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></li></ul></li> <li><ul><li><p>这种写法可以很好的支持并发，但是太复杂且容易出错。<code>sync.Once</code> 可以专门用来解决这种一次性初始化的问题。概念上来讲，一次性的初始化需要一个互斥量 mutex 和一个 boolean 变量来记录初始化是不是已经完成了；互斥量用来保护 boolean 变量和客户端数据结构。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> loadIconsOnce sync<span class="token punctuation">.</span>Once
<span class="token keyword">var</span> icons <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>image<span class="token punctuation">.</span>Image

<span class="token keyword">func</span> <span class="token function">Icon</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> image<span class="token punctuation">.</span>Image <span class="token punctuation">{</span>
  loadIconsOnce<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>loadIcons<span class="token punctuation">)</span>
  <span class="token keyword">return</span> icons<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>每一次对 Do 的调用先会检查 boolean 变量，如果不为 true，则锁定 mutex；如果为 true，则什么也不做（只会 Do Once）。mutex 同步会保证 loadIcons 对内存产生的效果能够对所有 goroutine 可见，用这种方式来使用 sync.Once，能够避免变量被构建完成之前和其他 goroutine 共享该变量。（可能是只有 Do 结束了，才会将 boolean 置为 true、释放锁？）</p> <blockquote><p>sync.Once 源码</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Once<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>o<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      o<span class="token punctuation">.</span><span class="token function">doSlow</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Once<span class="token punctuation">)</span> <span class="token function">doSlow</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    o<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> o<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> o<span class="token punctuation">.</span>done <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token keyword">defer</span> atomic<span class="token punctuation">.</span><span class="token function">StoreUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>o<span class="token punctuation">.</span>done<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>不能先释放锁，再修改 o.done：如果先释放锁，还没有修改完 o.done，另一个 goroutine 判断 o.done == 0，然后重复调用 f()。</p></blockquote></li></ul></li> <li><p>竞争条件检测：Go 的动态分析工具<code>竞争检查器（the race detector）</code></p> <p>在 go build go run go test 命令后面加上 -race，就会让编译器构建一个附带记录所有运行期对共享变量访问工具的 test，并且会记录下每一个读或者写共享变量的 goroutine 的身份信息；记录下所有的同步事件（go 语句，channel 操作，<code>(*sync.Mutex).Lock, (*sync.WaitGroup).Wait</code> 等等）</p> <blockquote><p>竞争检查器会检查这些事件，会寻找在哪一个goroutine中出现了这样的case，例如其读或者写了一个共享变量，这个共享变量是被另一个goroutine在没有进行干预同步操作便直接写入的。这种情况也就表明了是对一个共享变量的并发访问，即数据竞争。这个工具会打印一份报告，内容包含变量身份，读取和写入的goroutine中活跃的函数的调用栈。</p></blockquote> <p>然而，它只能检测到运行时的竞争条件；并不能证明之后不会发生数据竞争。所以为了使结果尽量正确，请保证你的测试并发地覆盖到了你的包。</p></li> <li><p>示例：并发的非阻塞缓存，解决方案是并发安全的，且会避免对整个缓存加锁而导致所有操作都去争一个锁的设计</p> <p>需要缓存的函数：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">httpGetBody</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>ReadAll 返回结果为 ([]byte, error)，使用 (interface{}, error) 是为了使其可以与缓存匹配</p> <ol><li><p>第一个版本：Memo 会记录需要缓存的函数 f 和缓存的内容（一个 map）</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Memo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	f     Func
	cache <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>result
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Func <span class="token keyword">func</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> result <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	err   <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>f Func<span class="token punctuation">)</span> <span class="token operator">*</span>Memo <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Memo<span class="token punctuation">{</span>f<span class="token punctuation">:</span> f<span class="token punctuation">,</span> cache<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>result<span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>memo <span class="token operator">*</span>Memo<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	res<span class="token punctuation">,</span> ok <span class="token operator">:=</span> memo<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span>value<span class="token punctuation">,</span> res<span class="token punctuation">.</span>err <span class="token operator">=</span> memo<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
		memo<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> res
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> res<span class="token punctuation">.</span>value<span class="token punctuation">,</span> res<span class="token punctuation">.</span>err
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>测试函数（顺序执行）：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">incomingURLs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
			<span class="token string">&quot;https://www.baidu.com&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://github.com&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://leetcode-cn.com/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://www.bilibili.com/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://www.bing.com/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://www.baidu.com&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://github.com&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://leetcode-cn.com/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://www.bilibili.com/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://www.bing.com/&quot;</span><span class="token punctuation">,</span>
			<span class="token string">&quot;https://www.baidu.com&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span> <span class="token punctuation">{</span>
			ch <span class="token operator">&lt;-</span> url
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ch
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Sequential</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> m M<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">incomingURLs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		value<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s, %s, %d bytes\n&quot;</span><span class="token punctuation">,</span>
			url<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Test</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token function">New</span><span class="token punctuation">(</span>httpGetBody<span class="token punctuation">)</span>
	<span class="token function">Sequential</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>测试结果：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token operator">==</span><span class="token operator">=</span> RUN   Test
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token punctuation">,</span> <span class="token number">158.956292</span>ms<span class="token punctuation">,</span> <span class="token number">227</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token punctuation">,</span> <span class="token number">516.751</span>ms<span class="token punctuation">,</span> <span class="token number">209030</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>leetcode<span class="token operator">-</span>cn<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">128.416209</span>ms<span class="token punctuation">,</span> <span class="token number">6342</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>bilibili<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">637.828667</span>ms<span class="token punctuation">,</span> <span class="token number">3530</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>bing<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">676.848542</span>ms<span class="token punctuation">,</span> <span class="token number">79518</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token punctuation">,</span> <span class="token number">2.375</span>µs<span class="token punctuation">,</span> <span class="token number">227</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token punctuation">,</span> <span class="token number">209</span>ns<span class="token punctuation">,</span> <span class="token number">209030</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>leetcode<span class="token operator">-</span>cn<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">84</span>ns<span class="token punctuation">,</span> <span class="token number">6342</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>bilibili<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">125</span>ns<span class="token punctuation">,</span> <span class="token number">3530</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>bing<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">416</span>ns<span class="token punctuation">,</span> <span class="token number">79518</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token punctuation">,</span> <span class="token number">125</span>ns<span class="token punctuation">,</span> <span class="token number">227</span> bytes
<span class="token operator">--</span><span class="token operator">-</span> PASS<span class="token punctuation">:</span> Test <span class="token punctuation">(</span><span class="token number">2.12</span>s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>采用并发形式，使用 <code>sync.WaitGroup</code> 使得测试函数等待所有请求都完成后再返回</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> M <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Concurrent</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> m M<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> n sync<span class="token punctuation">.</span>WaitGroup
	<span class="token keyword">for</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">incomingURLs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		n<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			value<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s, %s, %d bytes\n&quot;</span><span class="token punctuation">,</span>
				url<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			n<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	n<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestConcurrent</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token function">New</span><span class="token punctuation">(</span>httpGetBody<span class="token punctuation">)</span>
	<span class="token function">Concurrent</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>测试结果：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token operator">==</span><span class="token operator">=</span> RUN   TestConcurrent
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token punctuation">,</span> <span class="token number">73.460958</span>ms<span class="token punctuation">,</span> <span class="token number">227</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token punctuation">,</span> <span class="token number">75.82725</span>ms<span class="token punctuation">,</span> <span class="token number">227</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token punctuation">,</span> <span class="token number">76.607375</span>ms<span class="token punctuation">,</span> <span class="token number">227</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>leetcode<span class="token operator">-</span>cn<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">131.723125</span>ms<span class="token punctuation">,</span> <span class="token number">6342</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>leetcode<span class="token operator">-</span>cn<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">136.202792</span>ms<span class="token punctuation">,</span> <span class="token number">6342</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token punctuation">,</span> <span class="token number">523.831292</span>ms<span class="token punctuation">,</span> <span class="token number">209030</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token punctuation">,</span> <span class="token number">524.868875</span>ms<span class="token punctuation">,</span> <span class="token number">209030</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>bilibili<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">698.932208</span>ms<span class="token punctuation">,</span> <span class="token number">3530</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>bing<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">740.73925</span>ms<span class="token punctuation">,</span> <span class="token number">79539</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>bing<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">854.6185</span>ms<span class="token punctuation">,</span> <span class="token number">79540</span> bytes
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>bilibili<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token number">1.160798208</span>s<span class="token punctuation">,</span> <span class="token number">3530</span> bytes
<span class="token operator">--</span><span class="token operator">-</span> PASS<span class="token punctuation">:</span> TestConcurrent <span class="token punctuation">(</span><span class="token number">1.16</span>s<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这个测试不是每次都能够正常工作。我们注意到有一些意料之外的cache miss（缓存未命中），或者命中了缓存但却返回了错误的值，或者甚至会直接崩溃。虽然是并行的，但好像缓存没起作用。</p> <p>（命中了缓存返回错误的值，是不是 value 还没完全存到 map 里面，就直接命中了 key？）</p> <p>采用 -race 竞争检测器来运行：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>WARNING<span class="token punctuation">:</span> DATA RACE
Write at <span class="token number">0x00c00009cf30</span> by goroutine <span class="token number">11</span><span class="token punctuation">:</span>
  runtime<span class="token punctuation">.</span><span class="token function">mapassign_faststr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>src<span class="token operator">/</span>runtime<span class="token operator">/</span>map_faststr<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">203</span> <span class="token operator">+</span><span class="token number">0x0</span>
  memo<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Memo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      memo1<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">23</span> <span class="token operator">+</span><span class="token number">0x124</span>
	<span class="token comment">//...</span>

Previous write at <span class="token number">0x00c00009cf30</span> by goroutine <span class="token number">16</span><span class="token punctuation">:</span>
  runtime<span class="token punctuation">.</span><span class="token function">mapassign_faststr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>src<span class="token operator">/</span>runtime<span class="token operator">/</span>map_faststr<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">203</span> <span class="token operator">+</span><span class="token number">0x0</span>
  memo<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Memo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      memo1<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">23</span> <span class="token operator">+</span><span class="token number">0x124</span>
	<span class="token comment">//...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>有两个 goroutine 在没有同步干预的情况下更新了 map 的同一个 key，所以 Get 存在数据竞争，并非并发安全。</p></li> <li><p>基于监控的同步，给 Memo 加上一个 mutex，在 Get 的一开始获取互斥锁，return 时释放锁</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Memo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	f     Func
	mu    sync<span class="token punctuation">.</span>Mutex
	cache <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>result
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>memo <span class="token operator">*</span>Memo<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	memo<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> memo<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	res<span class="token punctuation">,</span> ok <span class="token operator">:=</span> memo<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span>value<span class="token punctuation">,</span> res<span class="token punctuation">.</span>err <span class="token operator">=</span> memo<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
		memo<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> res
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> res<span class="token punctuation">.</span>value<span class="token punctuation">,</span> res<span class="token punctuation">.</span>err
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>并发运行的测试中，竞争检查器没有检测到数据竞争，但是对于 memo 加锁，导致丧失了并发的优点，对 f 的调用又变成串行化了。</p></li> <li><p>修改 Get，改为在 goroutine 中获取两次锁：查找阶段获取一次，如果查找没有返回任何内容，那么进入更新阶段会再次获取一次。在这两次获取锁的中间阶段，其他 goroutine 可以随意使用 cache。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>memo <span class="token operator">*</span>Memo<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	memo<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	res<span class="token punctuation">,</span> ok <span class="token operator">:=</span> memo<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	memo<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		res<span class="token punctuation">.</span>value<span class="token punctuation">,</span> res<span class="token punctuation">.</span>err <span class="token operator">=</span> memo<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>

		memo<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		memo<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> res
		memo<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> res<span class="token punctuation">.</span>value<span class="token punctuation">,</span> res<span class="token punctuation">.</span>err
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>虽然这么写可以提升性能，但是由于 f 函数运行很慢，大部分的 URL 还是被请求了多次（多个 goroutine 都查 memo 得 ok 为 false，都去运行 f 函数、都去更新 map，其中一个的结果会覆盖另外一个）</p></li> <li><p>理想情况下是避免多余的工作，这种避免的工作一般被称为 duplicate suppression（重复抑制/避免）。下面的版本中 ready 除了包含 map 的 result，还包含一个叫 ready 的 channel，在这个条目被设置之后，这个 channel 就会被关闭，以向其他 goroutine 广播去获取该条目内的结果是安全的了</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> entry <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	res   result
	ready <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Memo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	f     Func
	mu    sync<span class="token punctuation">.</span>Mutex
	cache <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>entry
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>f Func<span class="token punctuation">)</span> <span class="token operator">*</span>Memo <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Memo<span class="token punctuation">{</span>f<span class="token punctuation">:</span> f<span class="token punctuation">,</span> cache<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>entry<span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>memo <span class="token operator">*</span>Memo<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	memo<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	e <span class="token operator">:=</span> memo<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token keyword">if</span> e <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		e <span class="token operator">=</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">{</span>ready<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
		memo<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> e
		<span class="token comment">// 设置完 e 后解锁，之后的 goroutine 会走进下面的 else</span>
		<span class="token comment">// 分支，来等待 cache 更新完毕</span>
		memo<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		e<span class="token punctuation">.</span>res<span class="token punctuation">.</span>value<span class="token punctuation">,</span> e<span class="token punctuation">.</span>res<span class="token punctuation">.</span>err <span class="token operator">=</span> memo<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
		<span class="token comment">// 更新完 map[key] 后广播</span>
		<span class="token function">close</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>ready<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		memo<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token operator">&lt;-</span>e<span class="token punctuation">.</span>ready
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> e<span class="token punctuation">.</span>res<span class="token punctuation">.</span>value<span class="token punctuation">,</span> e<span class="token punctuation">.</span>res<span class="token punctuation">.</span>err <span class="token comment">// 不需要互斥锁</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>本质是通过两个锁，一个锁限制读取 cache + 设置 cache[key] 为非 nil；另一个锁用于更新 cache[key] 直至完成。通过指针，使得 e.res.value、e.res.err 在多个 goroutine 之间共享。</p> <p>尽管多个 goroutine 会同时访问 e.res，但不需要互斥锁。因为 ready channel 的关闭必定先于其他 goroutine 读取 e.res，即写操作必然发生在读操作之前，所以不会发生数据竞争。</p></li> <li><p>与把 map 限制在一个单独 goroutine 中进行对比：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> request <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	key      <span class="token builtin">string</span>
	response <span class="token keyword">chan</span><span class="token operator">&lt;-</span> result
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Memo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	requests <span class="token keyword">chan</span> request
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>f Func<span class="token punctuation">)</span> <span class="token operator">*</span>Memo <span class="token punctuation">{</span>
	memo <span class="token operator">:=</span> <span class="token operator">&amp;</span>Memo<span class="token punctuation">{</span>requests<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> request<span class="token punctuation">)</span><span class="token punctuation">}</span>
	<span class="token keyword">go</span> memo<span class="token punctuation">.</span><span class="token function">server</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token keyword">return</span> memo
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>memo <span class="token operator">*</span>Memo<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	response <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> result<span class="token punctuation">)</span>
	memo<span class="token punctuation">.</span>requests <span class="token operator">&lt;-</span> request<span class="token punctuation">{</span>key<span class="token punctuation">,</span> response<span class="token punctuation">}</span>
	res <span class="token operator">:=</span> <span class="token operator">&lt;-</span>response
	<span class="token keyword">return</span> res<span class="token punctuation">.</span>value<span class="token punctuation">,</span> res<span class="token punctuation">.</span>err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>memo <span class="token operator">*</span>Memo<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">close</span><span class="token punctuation">(</span>memo<span class="token punctuation">.</span>requests<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>server 这个 goroutine 是 cache 的 monitor goroutine，get goroutine 通过 request channel 来和 monitor goroutine 通信：get goroutine 封装一个请求发送到 request channel 中，在 server goroutine 中，request 接收到这个请求，经过处理（通过 f 函数或者 cache 查询）将结果发送到 request 中的 response channel 中，即传回 get goroutine，完成通信。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>memo <span class="token operator">*</span>Memo<span class="token punctuation">)</span> <span class="token function">server</span><span class="token punctuation">(</span>f Func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	cache <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>entry<span class="token punctuation">)</span>
	<span class="token keyword">for</span> req <span class="token operator">:=</span> <span class="token keyword">range</span> memo<span class="token punctuation">.</span>requests <span class="token punctuation">{</span>
		e <span class="token operator">:=</span> cache<span class="token punctuation">[</span>req<span class="token punctuation">.</span>key<span class="token punctuation">]</span>
		<span class="token keyword">if</span> e <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			e <span class="token operator">=</span> <span class="token operator">&amp;</span>entry<span class="token punctuation">{</span>ready<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
			<span class="token comment">// 因为只有 server 这一个 goroutine 在修改 cache</span>
			<span class="token comment">// 所以这里可以不加锁</span>
			<span class="token comment">// 另外的 goroutine 要等 range 的下一次遍历</span>
			<span class="token comment">// 不存在两个 key 相同的 goroutine 同时命中 e == nil</span>
			cache<span class="token punctuation">[</span>req<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> e
			<span class="token keyword">go</span> e<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> req<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">go</span> e<span class="token punctuation">.</span><span class="token function">deliver</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>entry<span class="token punctuation">)</span> <span class="token function">call</span><span class="token punctuation">(</span>f Func<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	e<span class="token punctuation">.</span>res<span class="token punctuation">.</span>value<span class="token punctuation">,</span> e<span class="token punctuation">.</span>res<span class="token punctuation">.</span>err <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token function">close</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token comment">// 通知卡在 deliver goroutine 可以返回查询了</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>entry<span class="token punctuation">)</span> <span class="token function">deliver</span><span class="token punctuation">(</span>response <span class="token keyword">chan</span><span class="token operator">&lt;-</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">&lt;-</span>e<span class="token punctuation">.</span>ready
	response <span class="token operator">&lt;-</span> e<span class="token punctuation">.</span>res
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这个例子说明我们无论用上锁，还是通信来建立并发程序都是可行的。</p> <p>上面的两种方案并不好说特定情境下哪种更好，不过了解他们还是有价值的。有时候从一种方式切换到另一种可以使你的代码更为简洁。</p></li></ol></li> <li><p>Goroutines 和线程</p> <ul><li><p>动态栈：每一个 OS 线程都有一个固定大小的内存块（一般为 2MB）来做栈，这个栈会用来存储当前正在被调用或挂起（在调用其他函数时）的函数的内部变量。但固定大小的栈有时候是内存浪费（对于成千上百个 goroutine 而言不现实）。</p> <p>一个 goroutine 会以一个很小的栈开始其生命周期（一般为 2KB）。一个 goroutine 的栈和操作系统线程一样，会保存其活跃或挂起的函数调用的本地变量；goroutine 栈大小不是固定的，会根据需要动态的伸缩，最大能达到 1GB。</p></li> <li><p>goroutine 调度：OS 线程会被 OS 内核调度，每几毫秒，一个硬件计时器会中断处理器，这会调用一个叫作 scheduler 的内核函数，这个函数会挂起当前执行的线程并将它的寄存器内容保存到内存中，检查线程列表并决定下一次哪个线程可以被运行，并从内存中恢复该线程的寄存器信息，然后恢复执行该线程的现场并开始执行该线程。因为操作系统是被内核所调度，所以从一个线程向另一个移动需要完整的上下文切换，也就是说，保存一个用户线程的状态到内存，恢复另一个线程的状态到寄存器，然后更新调度器的数据结构，这几步操作很慢，因为其局部性很差，需要几次内存访问，并且会增加运行的 cpu 周期。</p> <p>Go 的运行时包含了其自己的调度器，这个调度器使用了一些技术手段，比如 m: n 调度，因为其会在 n 个操作系统线程上多工（调度）m 个 goroutine。Go 调度器的工作和内核的调度是相似的，但是这个调度器只关注单独的 Go 程序中的 goroutine（按程序独立）。</p> <p>和操作系统的线程调度不同的是，<strong>Go 调度器并不是用一个硬件定时器</strong>，而是被 Go 语言“建筑”本身进行调度的。例如当一个 goroutine 调用了 time.Sleep，或者被 channel 调用或者 mutex 操作阻塞时，调度器会使其进入休眠并开始执行另一个 goroutine，直到时机到了再去唤醒第一个 goroutine。因为这种调度方式不需要进入内核的上下文，所以重新调度一个 goroutine 比调度一个线程代价要低得多。</p></li> <li><p>GOMAXPROCS：Go 的调度器使用一个叫做 GOMAXPROCS 的变量来决定会有多少个 OS 线程同时执行 Go 的代码，其默认值时运行机器上的 CPU 的核心数。在休眠中或者在通信中被阻塞的 goroutine 是不需要一个对应的线程来做调度的。在 I/O 中或系统调用中或调用非 Go 语言函数时，是需要一个对应的 OS 线程的，但是 GOMAXPROCS 并不需要将这几种情况计算在内。</p> <p>可以使用 GOMAXPROCS 环境变量显式控制这个参数：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

$ GOMAXPROCS<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">go</span> run gomaxprocs<span class="token punctuation">.</span><span class="token keyword">go</span> <span class="token comment">// 只有一个 goroutine 可以执行，不断切换</span>
<span class="token number">111111111111111111110000000000000000000011111.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

$ GOMAXPROCS<span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">go</span> run gomaxprocs<span class="token punctuation">.</span><span class="token keyword">go</span> <span class="token comment">// 两个 goroutine 一起执行，交叉打印</span>
<span class="token number">010101010101010101011001100101011010010100110.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li> <li><p>Goroutine 没有 ID 号：在大多数支持多线程的操作系统和程序语言中，当前的线程都有一个独特的身份（id），并且这个身份信息可以以一个普通值的形式被很容易地获取到，典型的可以是一个 integer 或者指针值。这种情况下我们做一个抽象化的 thread-local storage（线程本地存储，多线程编程中不希望其它线程访问的内容）就很容易，只需要以线程的 id 作为 key 的一个 map 就可以解决问题，每一个线程以其 id 就能从中获取到值，且和其它线程互不冲突。</p> <p>goroutine 没有可以被程序员获取到的身份（id）的概念。这一点是设计上故意而为之，由于thread-local storage 总是会被滥用。防止函数被身份信息影响其行为（类似全局变量，线程身份信息改变导致函数行为改变）</p></li></ul></li></ul> <p>​</p></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div></div></div>
    <script src="/assets/js/app.80d57d75.js" defer></script><script src="/assets/js/3.187167f1.js" defer></script><script src="/assets/js/1.965fe851.js" defer></script><script src="/assets/js/95.cf7f5192.js" defer></script>
  </body>
</html>
